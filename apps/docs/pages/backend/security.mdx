---
title: 系统权限
---

在管理系统中通常需要验证身份信息也就有了不同的功能权限。项目实现了基于 `JWT` 的身份认证，基于 `RBAC` 的访问控制。

## 权限装饰器

使用装饰器验证当前用户是否有权限访问当前的资源。

### @Public()

公开：不需要认证就能进入该方法。

```ts
import { Public } from '@/modules/security';

export class AppController {
  @Public()
  getHello() {}
}
```

### @RequireRoles()

角色认证：必须具有指定角色标识才能进入该方法。

```ts
import { Logical, RequireRoles } from '@/modules/security';

export class AppController {
  // 必须拥有 admin 角色才可访问
  @RequireRoles('admin')
  getHello() {}

  // 必须拥有 admin 和 common 角色才可访问
  @RequireRoles(['admin', 'common'])
  getHello() {}

  // 必须拥有 admin 或 common 角色才可访问
  @RequireRoles(['admin', 'common'], Logical.OR)
  getHello() {}
}
```

### @RequirePermissions()

权限认证：必须具有指定权限才能进入该方法。

```ts
import { Logical, RequirePermissions } from '@/modules/security';

export class AppController {
  // 必须拥有 system:user:add 权限才可访问
  @RequirePermissions('system:user:add')
  getHello() {}

  // 必须拥有 system:user:add 和 system:user:edit 权限才可访问
  @RequirePermissions(['system:user:add', 'system:user:edit'])
  getHello() {}

  // 必须拥有 system:user:add 或 system:user:edit 权限才可访问
  @RequirePermissions(['system:user:add', 'system:user:edit'], Logical.OR)
  getHello() {}
}
```

## 编程式验证权限

如果需要在业务逻辑中验证权限可以使用 [权限验证工具类](https://github.com/hexuntao/naa/blob/main/apps/api/src/modules/security/services/auth.service.ts) 提供的函数。

```ts
import { AuthService } from '@/modules/security';

export class AppController {
  constructor(private authService: AuthService) {}

  getHello() {
    // 检查角色
    if (this.authService.hasRole('admin')) {
      // 用户拥有 admin 角色
    }
    
    // 检查权限
    if (this.authService.hasPermission('system:user:add')) {
      // 用户拥有 system:user:add 权限
    }
    
    // 检查多个角色（AND 逻辑）
    if (this.authService.hasRoles(['admin', 'manager'], Logical.AND)) {
      // 用户同时拥有 admin 和 manager 角色
    }
    
    // 检查多个权限（OR 逻辑）
    if (this.authService.hasPermissions(['system:user:add', 'system:user:edit'], Logical.OR)) {
      // 用户拥有 system:user:add 或 system:user:edit 权限之一
    }
  }
}
```

## Token 管理

系统使用 JWT Token 进行身份认证，Token 相关信息由 `TokenService` 管理。

### Token 创建

```ts
import { TokenService } from '@/modules/security';

@Injectable()
export class AuthService {
  constructor(private tokenService: TokenService) {}
  
  async login(user: SysLoginUser) {
    // 创建 token
    const token = await this.tokenService.createToken(user);
    return token;
  }
}
```

### Token 验证

Token 验证由全局守卫自动处理，无需手动验证。如果需要手动验证：

```ts
const isValid = await this.tokenService.verifyToken(token);
if (isValid) {
  const loginUser = await this.tokenService.getLoginUser(token);
}
```

### Token 刷新

系统暂不支持 token 刷新，token 过期后需要重新登录。

## 注意事项

::: warning 权限标识格式
权限标识建议使用 `模块:功能:操作` 的格式，例如：
- `system:user:list` - 系统模块用户列表
- `system:user:add` - 系统模块用户新增
- `system:user:edit` - 系统模块用户编辑
- `system:user:remove` - 系统模块用户删除
:::

::: tip 超级管理员
用户 ID 为 1 的用户（通常是 admin）拥有所有权限，不受权限控制限制。这是系统内置的特殊处理。
:::

::: warning Token 安全
- Token 存储在 Redis 中，默认过期时间为 2 小时
- Token 包含用户基本信息，不要在前端存储敏感信息
- 建议使用 HTTPS 协议传输 Token
- 生产环境建议缩短 Token 有效期
:::

::: tip 权限缓存
用户权限信息会缓存在 Redis 中，修改用户角色或权限后，需要清除缓存或等待缓存过期。系统会在权限变更时自动清除相关缓存。
:::
